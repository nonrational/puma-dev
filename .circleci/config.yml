version: 2.1

commands:
  gem_install_puma:
    steps:
      - run: ruby --version
      - run: gem install puma

  go_test:
    steps:
      - checkout
      - run: go version
      - run: go mod download
      - run: go test -v -race -coverprofile=coverage.out -covermode=atomic -timeout=60s ./...

  macos_install_go_1_12:
    steps:
      - run:
          name: install go-1.12
          command: |
            brew install go@1.12
            echo 'export PATH="/usr/local/opt/go@1.12/bin:$PATH"' >> $BASH_ENV

  macos_prepare_filesystem:
    steps:
      - run:
          name: allow puma-dev to modify /etc/resolver
          command: |
            sudo mkdir -p /etc/resolver;
            sudo chmod 0775 /etc/resolver;
            sudo chown :staff /etc/resolver;

  macos_set_ruby_2_6:
    steps:
      - run:
          name: configure ruby-2.6
          command: echo 'chruby ruby-2.6' >> $BASH_ENV


jobs:
  test_catalina:
    macos:
      xcode: 11.4.0
    working_directory: /Users/distiller/go/src/puma/puma-dev
    environment:
      HOMEBREW_NO_AUTO_UPDATE: 1
      GO111MODULE: "on"
      GOPATH: "/Users/distiller/go"
    steps:
      - macos_prepare_filesystem
      - macos_install_go_1_12
      - macos_set_ruby_2_6
      - gem_install_puma
      - go_test

  test_mojave:
    macos:
      xcode: 11.1.0
    working_directory: /Users/distiller/go/src/puma/puma-dev
    environment:
      HOMEBREW_NO_AUTO_UPDATE: 1
      GO111MODULE: "on"
      GOPATH: "/Users/distiller/go"
    steps:
      - macos_prepare_filesystem
      - macos_install_go_1_12
      - macos_set_ruby_2_6
      - gem_install_puma
      - go_test

  test_high_sierra:
    macos:
      xcode: 10.1.0
    working_directory: /Users/distiller/go/src/puma/puma-dev
    environment:
      HOMEBREW_NO_AUTO_UPDATE: 1
      GO111MODULE: "on"
      GOPATH: "/Users/distiller/go"
    steps:
      - macos_prepare_filesystem
      - macos_install_go_1_12
      - macos_set_ruby_2_6
      - gem_install_puma
      - go_test

  test_linux:
    docker:
      - image: circleci/golang:1.12
      - image: circleci/ruby:2.6-stretch
    working_directory: /go/src/puma/puma-dev
    environment:
      GO111MODULE: "on"
    steps:
      - gem_install_puma
      - go_test

workflows:
  version: 2
  test:
    jobs:
      - test_catalina
      - test_mojave
      - test_linux

